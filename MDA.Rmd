---
title: 'Methodological Detail Appendix: Tighter Nets for Smaller Fishes? Mapping the
  Development of Statistical Practices in Consumer Research Between 2008 and 2020'
author: "Antonia Krefeld-Schwalb and Benjamin Scheibehenne"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    df_print: paged
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: hide
  html_notebook: 
    toc: yes
    toc_depth: '4'
---

The following skript runs all analyses reported in the manuscript "Tighter Nets for Smaller Fishes? Mapping the Development of Statistical Practices in Consumer Research Between 2008 and 2020". 

To re-run the analyses make sure that the required packages are installed and the data files 
 'Data.csv' with all text-mined coded manuscripts,  'Datahandcoded.csv' with all handcoded articles are in your working directory.
 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, error=FALSE, message=FALSE,warning = FALSE)


library(scales)
library(knitr)
library(stringr)
library(msm)
library(coda)
library(dplyr)
library(lme4)
library(tidyr)
require(data.table)
library(ggplot2)
library(grid)
library(gridExtra)
library(sjPlot)
library(RCurl)

```

\section{Preparation}

```{r loadData, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}





data <- read.csv("https://raw.githubusercontent.com/Akrefeld/StatisticalPracticesConsumerResearch/master/Data.csv", sep = ";")

data = data[!(duplicated(data[,1:20])),]


```


```{r ReadFtests, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
pFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[1]), split = ",")))
FFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$FFtests[1]), split = ",")))
df1=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d1Ftests[1]), split = ",")))
df2=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d2Ftests[1]), split = ",")))

NoStudyVec = rep(NA, length(data[,1]))

pFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[1]), split = ",")))
FtestCom <-  unlist(strsplit(gsub("\\[|\\]","",data$Ftests[1]), split = "', '"))
Journal = rep(data$Journal[1], length(FtestCom))
Year = rep(data$Year[1], length(FtestCom))
NoStudy=rep(max(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[1]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[1]), split = ",")))), length(FtestCom))
Mturk = rep(data$Mturk[1] != "[]", length(FtestCom))
Lab = rep(data$LabStudy[1] != "[]", length(FtestCom))
Field = rep(data$FieldStudy[1] != "[]", length(FtestCom))
Article = rep(1, length(pFtest))

test = rep(0, length(data$pvaluesFtests))
test[1] = length(FtestCom) - length(pFtest)

if(length(pFtest) < 1){FtestCom = pFtest=FFtest=df1=df2= NA
                          Journal= data$Journal[1]
                          Year =data$Year[1]
                          Article =1
                          NoStudy= max(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[1]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[1]), split = ","))))
                          Mturk = data$Mturk[1] != "[]"
                          Lab= data$LabStudy[1] != "[]"
                          Field= data$FieldStudy[1] != "[]"
                          }


dfpFtest <- cbind(FtestCom, 
                  pFtest, 
                  FFtest, 
                  df1, 
                  df2, 
                  Journal, 
                  Year, 
                  Article, 
                  NoStudy,
                  Mturk,
                  Lab,
                  Field)
errors = 0
for (i in 2:length(data$pvaluesFtests)){
  FtestCom <-  unlist(strsplit(gsub("\\[|\\]","", data$Ftests[i]), split = "', '"))
  pFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[i]), split = ",")))
  FFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$FFtests[i]), split = ",")))
  
  NoStudy=rep(max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ","))))), length(FtestCom))
  
  df1=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d1Ftests[i]), split = ",")))
  df2=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d2Ftests[i]), split = ",")))

  test[i] = length(FtestCom) == length(pFtest) & length(FtestCom) == length(FFtest) & length(FtestCom)== length(df1) & length(FtestCom) == length(df2)

  Journal = rep(data$Journal[i], length(FtestCom))
  Year = rep(data$Year[i], length(FtestCom))
  Article = rep(i, length(pFtest))
  Mturk = rep(length(unlist(strsplit(gsub("\\[|\\]|\\'","",data$Mturk[i]), split = ","))), length(FtestCom))
  Lab = rep(data$LabStudy[i] != "[]", length(FtestCom))
  Field = rep(data$FieldStudy[i] != "[]", length(FtestCom))
  
  if(length(pFtest) < 1){FtestCom = pFtest=FFtest=df1=df2= NA
                          Journal= data$Journal[i]
                          Year =data$Year[i]
                          Article =i
                          NoStudy= max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ",")))))
                          NoStudyVec[i]= max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ",")))))
                          Mturk = data$Mturk[i]!= "[]"
                          Lab= data$LabStudy[i] != "[]"
                          Field= data$FieldStudy[i] != "[]"
                          }

  
   
  dfpFtest <- rbind(dfpFtest,
                    cbind(FtestCom,
                          pFtest, 
                          FFtest, 
                          df1, 
                          df2, 
                          Journal,
                          Year, 
                          Article,
                          NoStudy,
                          Mturk,
                          Lab,
                          Field))

}



errorsF = which(test == F) 



dfpFtest[which(dfpFtest[,11]==1),11]= TRUE
dfpFtest[which(dfpFtest[,11]==0),11]= FALSE
dfpFtest[,11]= factor(dfpFtest[,11])


dfpFtest[which(dfpFtest[,12]==1),12]= TRUE
dfpFtest[which(dfpFtest[,12]==0),12]= FALSE
dfpFtest[,12]= factor(dfpFtest[,12])

dfpFtest = as.data.frame(dfpFtest)

dfpFtest[which(dfpFtest[,9] == -Inf), 9] = 1
dfpFtest[,9] = as.numeric(as.character(dfpFtest[,9]))
dfpFtest[which(dfpFtest[,9] > 12), 9] = 1
dfpFtest[,1] = gsub("p p", "p =", dfpFtest[,1])
dfpFtest[,1] = gsub("pp", "p =", dfpFtest[,1])
dfpFtest[,1] = gsub("p N", "p >", dfpFtest[,1])

dfpFtest$Mturk[dfpFtest$Mturk== "FALSE"] = 0 
dfpFtest$Mturk = as.numeric(as.character(dfpFtest$Mturk))


exactF =0

exactF = 1 - grepl("b|<|>",dfpFtest[,1])
prepF = as.numeric(as.character(dfpFtest$pFtest))
Fvalue = as.numeric(as.character(dfpFtest$FFtest))
df1 = as.numeric(as.character(dfpFtest$df1))
df2 = as.numeric(as.character(dfpFtest$df2))
NF = df2 + df1 +1
NpcF = NF/(df1 + 1)

omega2=(Fvalue-1)/(Fvalue+(df2+1)/df1)
eta2=Fvalue*df1/(Fvalue*df1+ df2)
rF=sqrt(omega2)


pcalF=1-pf(Fvalue, df1, df2)


dfpFtest = cbind(dfpFtest, pcalF)
dfpFtest = as.data.frame(dfpFtest)

PerArticleF= data[,c(18:21,13)]
for (i in 1:length(data$pvaluesFtests)){
  PerArticleF$FperArticle[i] =sum(dfpFtest[,8]==i)
  PerArticleF$FperArticle[i][data$Ftests[i] =="[]"] = 0
  PerArticleF$FperArticlep[i] =sum(dfpFtest[,8]==i & as.numeric(as.character(dfpFtest[,10])) < .05)
  PerArticleF$FperArticlep[i][data$Ftests[i] =="[]"] = 0
  PerArticleF$NoStudy[i] =as.numeric(as.character(unique(dfpFtest$NoStudy[dfpFtest[,8]==i])))
  if (is.na(as.numeric(as.character(unique(dfpFtest$NoStudy[dfpFtest[,8]==i]))))) PerArticleF$NoStudy[i] == 1
  PerArticleF$Lab[i] =unique(dfpFtest$Lab[dfpFtest[,8]==i])
  PerArticleF$Field[i] =unique(dfpFtest$Field[dfpFtest[,8]==i])
  PerArticleF$MturkF[i] = PerArticleF[i,5]!="[]"
  
}



```


```{r Readttests, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
pTtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[1]), split = ",")))
Tttests=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$Tttest[1]), split = ",")))
df=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$dfttest[1]), split = ",")))
pTtest=as.numeric(as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[1]), split = ","))))
TtestCom <-  unlist(strsplit(gsub("\\[|\\]","",data$ttests[1]), split = "', '"))


pTtest[length(TtestCom)==0] <- NA
Tttests[length(TtestCom)==0] <- NA
df[length(TtestCom)==0] <- NA
TtestCom[length(TtestCom)==0] <- NA
Journal = rep(data$Journal[1], length(TtestCom))
Year = rep(data$Year[1], length(TtestCom))

Article = rep(1, length(TtestCom))
test = rep(0, length(data$pvaluesttests))
test[1] = length(TtestCom) == length(Tttests) & length(TtestCom)== length(df) & length(TtestCom)== length(pTtest)
NoStudy=rep(max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ","))))), length(TtestCom))
Mturk = rep(data$Mturk[i] != "[]", length(TtestCom))
Lab = rep(data$LabStudy[i] != "[]", length(TtestCom))
Field = rep(data$FieldStudy[i] != "[]", length(TtestCom))
  
  if(length(pTtest) < 1){TtestCom = pTtest=Tttests=df= NA
                          Journal= data$Journal[i]
                          Year =data$Year[i]
                          Article =i
                          NoStudy=max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ",")))))
                          Mturk = data$Mturk[i] != "[]"
                          Lab= data$LabStudy[i] != "[]"
                          Field= data$FieldStudy[i] != "[]"
                          }

dfpTtest <- cbind(TtestCom, pTtest, Tttests, df, Journal, Year, Article, NoStudy, Mturk, Lab, Field)
  


for (i in 2:length(data$pvaluesttests)){
  TtestCom <-  unlist(strsplit(gsub("\\[|\\]","", data$ttests[i]), split = "', '"))
  pTtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[i]), split = ",")))
  Tttests=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$Tttest[i]), split = ",")))
  df=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$dfttest[i]), split = ",")))
   NoStudy=rep(max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ","))))), length(TtestCom))

  Journal = rep(data$Journal[i], length(TtestCom))
  Year = rep(data$Year[i], length(TtestCom))
  Mturk = rep(length(unlist(strsplit(gsub("\\[|\\]|\\'","",data$Mturk[i]), split = ","))), length(TtestCom))
  Article = rep(i, length(TtestCom))
  Lab = rep(data$LabStudy[i] != "[]", length(TtestCom))
  Field = rep(data$FieldStudy[i] != "[]", length(TtestCom))
  
  
    if(length(pTtest) < 1){TtestCom = pTtest=Tttests=df= NA
                          Journal= data$Journal[i]
                          Year =data$Year[i]
                          Article =i
                          NoStudy= max(c(as.numeric(unlist(strsplit(gsub("\\[|\\]|experiment |\\'", "", data$NoExperiment[i]), split = ","))),as.numeric(unlist(strsplit(gsub("\\[|\\]|study |\\'", "", data$NoStudy[i]), split = ",")))))
                          Mturk = data$Mturk[i]!= "[]"
                          Lab= data$LabStudy[i] != "[]"
                          Field= data$FieldStudy[i] != "[]"
                          }
    test[i] = length(TtestCom) == length(Tttests) & length(TtestCom)== length(df) & length(TtestCom)== length(pTtest)
  if (test[i]==F) {
    print(i)}
  dfpTtest <- rbind(dfpTtest,
                    cbind(TtestCom, 
                          pTtest, 
                          Tttests, 
                          df, 
                          Journal, 
                          Year, 
                          Article, 
                          NoStudy, 
                          Mturk, Lab, Field))
                    
}

dfpTtest =as.data.frame(dfpTtest)


errorsT = which(test == F)

exactt = 1 - grepl("b|<|>",dfpTtest[,1])#str_count(dfpTtest[,1], "=") + str_count(dfpTtest[,1], "p")
prept = as.numeric(as.character(dfpTtest$pTtest))
Tvalue = as.numeric(as.character(dfpTtest$Tttests))
Tvalue[Tvalue < 0 & !is.na(Tvalue)] = abs(Tvalue[Tvalue < 0& !is.na(Tvalue)])
df = as.numeric(as.character(dfpTtest$df))

Nt = df + 2
NpCt = Nt/2

d = 2*Tvalue/sqrt(Nt)



#sqrt(N/.5 )*(d/(sqrt(2)))- qnorm(1-alpha)= qnorm(po)
#transform d to r assuming equal sample sizes, thus correction factor a = 4
rt = d/sqrt(d^2 + (Nt^2-2*Nt)/(.5*Nt)^2)

dfpTtest$Mturk[dfpTtest$Mturk== "FALSE"] = 0 
dfpTtest$Mturk = as.numeric(as.character(dfpTtest$Mturk))

pcalt=1-pt(Tvalue, df,0)
dfpTtest = cbind(dfpTtest, pcalt)


dfpTtest[which(dfpTtest[,8] == -Inf), 8] = 1

dfpTtest[,8] = as.numeric(as.character(dfpTtest[,8]))
dfpTtest[which(dfpTtest[,8] > 14), 8] = 1


dfpTtest[which(dfpTtest[,10]==1),10]= TRUE
dfpTtest[which(dfpTtest[,10]==0),10]= FALSE
dfpTtest[,10] = factor(dfpTtest[,10])

dfpTtest[which(dfpTtest[,11]==1),11]= TRUE
dfpTtest[which(dfpTtest[,11]==0),11]= FALSE
dfpTtest[,11] = factor(dfpTtest[,11])


PerArticlet= data[,c(18:21,13)]

for (i in 1:length(data$pvaluesttests)){
  PerArticlet$TperArticle[i] = sum(dfpTtest[,7]==i) 
  PerArticlet$TperArticle[i][data$ttests[i] =="[]"] = 0
  PerArticlet$TperArticlep[i] =sum(dfpTtest[,7]==i & as.numeric(as.character(dfpTtest[,9])) < .05)
  PerArticlet$TperArticlep[i][data$ttests[i] =="[]"] = 0
  PerArticlet$NoStudy[i] =as.numeric(as.character(unique(dfpTtest$NoStudy[dfpTtest[,7]==i])))
  
  if (is.na(as.numeric(as.character(unique(dfpTtest$NoStudy[dfpTtest[,7]==i])))))PerArticlet$NoStudy[i] == 1
  PerArticlet$Lab[i] =unique(dfpTtest$Lab[dfpTtest[,7]==i])
  PerArticlet$Field[i] =unique(dfpTtest$Field[dfpTtest[,7]==i])
  PerArticlet$MturkF[i] = PerArticlet[i,5]!="[]"
}

```

```{r Summary, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
PerArticle = PerArticlet[,-5]

PerArticle[,5:6] = PerArticlet[,6:7]+PerArticleF[,7:8]

colnames(PerArticle) =  c("Journal", "Year", "Issue", "Article", "Tests", "signp", "NoStudy", "Lab", "Field", "Mturk")


dfpFtest = as.data.frame(dfpFtest)
dfpTtest = as.data.frame(dfpTtest)


summaryTests = rbind(cbind(NF, NpcF, rF,prepF, pcalF, exactF, dfpFtest$Journal, dfpFtest$Year, dfpFtest$Article, dfpFtest$NoStudy,dfpFtest$Mturk, dfpFtest$Lab, dfpFtest$Field, rep("F", length(NF))),
                     cbind(Nt,NpCt, rt,prept, pcalt, exactt, dfpTtest$Journal, dfpTtest$Year, dfpTtest$Article, dfpTtest$NoStudy, dfpTtest$Mturk, dfpTtest$Lab, dfpTtest$Field, rep("t", length(Nt))))
summaryTests = as.data.frame(summaryTests)

summaryTests[,1] = as.numeric(as.character(summaryTests[,1]))
summaryTests[,2] = as.numeric(as.character(summaryTests[,2]))

summaryTests[,3] = as.numeric(as.character(summaryTests[,3]))
summaryTests[,4] = as.numeric(as.character(summaryTests[,4]))

summaryTests[,5] = as.numeric(as.character(summaryTests[,5]))




colnames(summaryTests) = c("N", "Npc", "r", "prep", "pcal",  "exact", "Journal", "Year", "Article", "NoStudy", "Mturk", "Lab", "Field", "Type")
summaryTests$Mturk[is.na(summaryTests$Mturk)] = 0
summaryTests$NoStudy[is.na(summaryTests$NoStudy)] = 1

summaryTests$MturkCat = as.numeric(as.character(summaryTests$Mturk))>1 


summaryTestsRnd =summaryTests[1:length(unique(summaryTests$Article)),]
for (a in 1:length(unique(summaryTests$Article))){
  
  Linetemp = sample(which(summaryTests$Article == unique(summaryTests$Article)[a]),1)
  summaryTestsRnd[a,] = summaryTests[Linetemp,]
  
}


```





  

```{r echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}


NPCall = ggplot(summaryTests, aes(y = Npc, x= Year, col = Journal, group = Journal, shape = Journal))+
  geom_point(position = position_jitterdodge(dodge.width = .6), alpha = .05, na.rm = TRUE) +
  stat_summary(fun.y = "median", geom = "line",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  stat_summary(fun.data = "median_hilow", fun.args=list(conf.int=0.5),geom = "pointrange",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  coord_cartesian(ylim= c(0,500))+
  scale_color_manual(values = c("red","blue","orange"), label= c("JCP", "JCR", "JMR"), name = "Journal")+
  scale_shape_manual(values = c(0,1,2), label= c("JCP", "JCR", "JMR"), name = "Journal")+
  scale_x_discrete(name = "Year", breaks = c(11,12,13,14,15,16,17,18), labels = c("2011","2012","2013","2014","2015","2016","2017","2018"))+
                theme_classic()+  
                ylab("Sample Size per Cell")+
                theme(tex = element_text(size=12),
                      plot.title = element_text(hjust=.5, size=15, face="bold"))+
  theme(axis.ticks.length=unit(-0.15, "cm"), axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), legend.position = "bottom" )

```


\section{Effect sizes}

The effect sizes of the F, $\omega^2$, and t-test, d, were transformed to the commmon r-scale, to be analyzed and plotted together. 


```{r echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}


rAll = ggplot(summaryTests, aes(y = r, x= Year, col = Journal, group = Journal, shape = Journal))+
#geom_violin(draw_quantiles = c(0.025, 0.5, 0.975))+
  stat_summary(fun.y = "median", geom = "line",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  stat_summary(fun.data = "median_hilow", fun.args=list(conf.int=0.5),geom = "pointrange",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  scale_shape_manual(values = c(0,1,2), label= c("JCP", "JCR", "JMR"), name = "Journal")+
  scale_color_manual(values = c("black","red","blue","orange"), label= c("Control","JCP", "JCR", "JMR"), name = "Journal")+
  geom_hline(yintercept = .1, linetype = 2)+
  geom_text(aes(y = .13, x = 8.25, label = "small", col = "black" ))+
  geom_hline(yintercept = .3, linetype = 2)+
  geom_text(aes(y = .33, x = 8.25, label = "medium", col = "black"))+
  geom_hline(yintercept = .5, linetype = 2)+
  geom_text(aes(y = .53, x = 8.25, label = "large", col = "black" ))+

  ylab(expression(paste("Effect size r")))+
  geom_point(position = position_jitterdodge(dodge.width = .6), alpha = .05, na.rm = TRUE) +
  
  #c
  scale_x_discrete(name = "Year", breaks = c(11,12,13,14,15,16,17,18), labels = c("2011","2012","2013","2014","2015","2016","2017","2018"))+
                theme_classic()+  
                #ggtitle("Effect Size")+
                theme(tex = element_text(size=12),
                      plot.title = element_text(hjust=.5, size=15, face="bold"))+
  theme(axis.ticks.length=unit(-0.15, "cm"), axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")) )


```



\section{read and prepare data for  hand coded manuscripts}


```{r, loadmanuallycoded}
data<- read.csv("https://raw.githubusercontent.com/Akrefeld/StatisticalPracticesConsumerResearch/master/datahandcoded_January2021.csv", sep = ",")


```


```{r ReadFtestsMC, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
pFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[1]), split = ",")))
FFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$FFtests[1]), split = ",")))
df1=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d1Ftests[1]), split = ",")))
df2=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","", data$d2Ftests[1]), split = ",")))
Within=unlist(strsplit(gsub("\\[|\\]|\\'","", data$within[1]), split = ","))
Centrality=unlist(strsplit(gsub("\\[|\\]|\\'","", data$centrality[1]), split = ","))
Mturk=unlist(strsplit(gsub("\\[|\\]|\\'","", data$OnlineSampleF[1]), split = ","))


pFtest=as.numeric(unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[1]), split = ",")))
FtestCom <-  unlist(strsplit(gsub("\\[|\\]","",data$Ftests[1]), split = "', '"))
Journal = rep(data$Journal[1], length(FtestCom))
Year = rep(data$Year[1], length(FtestCom))
Article = rep(1, length(pFtest))
test = rep(0, length(data$pvaluesFtests))
test[1] = length(FtestCom) - length(pFtest)

dfpFtest <- cbind(FtestCom, pFtest, FFtest, df1, df2, Centrality, Mturk, Journal, Year, Article, Within)


for (i in 2:length(data$pvaluesFtests)){
  FtestCom <-  unlist(strsplit(gsub("\\[|\\]","", data$Ftests[i]), split = "', '"))
  pFtest=unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesFtests[i]), split = ","))
  Centrality=unlist(strsplit(gsub("\\[|\\]|\\'","",data$centrality[i]), split = ","))
  Within=unlist(strsplit(gsub("\\[|\\]|\\'","", data$within[i]), split = ","))
  Mturk=unlist(strsplit(gsub("\\[|\\]|\\'","",data$OnlineSampleF[i]), split = ","))
  FFtest=unlist(strsplit(gsub("\\[|\\]|\\'","",data$FFtests[i]), split = ","))
  df1=unlist(strsplit(gsub("\\[|\\]|\\'","", data$d1Ftests[i]), split = ","))
  df2=unlist(strsplit(gsub("\\[|\\]|\\'","", data$d2Ftests[i]), split = ","))
  Within[length(FtestCom)==0] <- NA
  Centrality[length(FtestCom)==0] <- NA
  Mturk[length(FtestCom)==0] <- NA
  pFtest[length(FtestCom)==0] <- NA
  FtestCom[length(FtestCom)==0] <- NA
  FFtest[length(FtestCom)==0] <- NA
  df1[length(FtestCom)==0] <- NA
  df2[length(FtestCom)==0] <- NA
  test[i] = length(FtestCom) - length(pFtest)
  Journal = rep(data$Journal[i], length(FtestCom))
  Year = rep(data$Year[i], length(FtestCom))

  Article = rep(i, length(pFtest))
  dfpFtest <- rbind(dfpFtest,
                    cbind(FtestCom, pFtest, FFtest, df1, df2, Centrality, Mturk, Journal, Year, Article, Within))
}

errorsF = which(test != 0)

###number of wrong p-vlues bigger .05

dfpFtest[,1] = gsub("p p", "p =", dfpFtest[,1])
dfpFtest[,1] = gsub("pp", "p =", dfpFtest[,1])
dfpFtest[,1] = gsub("p N", "p >", dfpFtest[,1])

exactF =0
dfpFtest = as.data.frame(dfpFtest)
  
exactF = 1 - grepl("b|<|>",dfpFtest$FtestCom)#str_count(dfpFtest[,1], "=") + str_count(dfpFtest[,1], "p")
prepF = as.numeric(as.character(dfpFtest[,2]))
Fvalue = as.numeric(as.character(dfpFtest[,3]))
df1 = as.numeric(as.character(dfpFtest[,4]))
df2 = as.numeric(as.character(dfpFtest[,5]))
NF = df2 + df1 +1

omega2=(Fvalue-1)/(Fvalue+(df2+1)/df1)
eta2=Fvalue*df1/(Fvalue*df1+ df2)
rF=sqrt(omega2)

dfpFtest$Mturk[dfpFtest$Mturk ==" n"| dfpFtest$Mturk ==" n "| dfpFtest$Mturk =="   n"| dfpFtest$Mturk ==" N"|dfpFtest$Mturk ==" pn"| is.na(dfpFtest$Mturk)] = "n"
dfpFtest$Mturk[dfpFtest$Mturk ==" y"| dfpFtest$Mturk ==" y "] = "y"

dfpFtest$Mturk[dfpFtest$Mturk ==" y"| dfpFtest$Mturk ==" y "] = "y"
dfpFtest$Mturk = factor(dfpFtest$Mturk)


pcalF=1-pf(Fvalue, df1, df2)

PerArticleF= as.data.frame(cbind(data$Year, data$Journal, data$Type.of.Study, data$Nocoauthors))

for (i in 1:length(data$pvaluesFtests)){
  PerArticleF$FperArticle[i] =length(dfpFtest[dfpFtest$Article==i & dfpFtest$Centrality != "m" ,1]) 
  PerArticleF$FperArticle[i][data$Ftests[i] =="[]"] = 0
  PerArticleF$FperArticlep[i] =length(dfpFtest[dfpFtest$Article==i & dfpFtest$Centrality != "m"  & as.numeric(dfpFtest$pFtest) < .05,1]) 
  PerArticleF$FperArticlep[i][data$Ftests =="[]"] = 0
  PerArticleF$NoCoauthors[i]= data$Nocoauthors[i]
  PerArticleF$NoStudies[i]=  sum(unlist(strsplit(gsub("\\[|\\]|\\'","", data$Type.of.Study[i]), split = ",")) != "")
  PerArticleF$TypeStudies[i]=   sum(unlist(strsplit(gsub("\\[|\\]|\\'","", data$Type.of.Study[i]), split = ",")) %in% c("field", " field"))
}

dfpFtest$Centrality[as.character(dfpFtest$Centrality) == " p"] = 'p'
dfpFtest$Centrality[as.character(dfpFtest$Centrality) == " m"] = 'm'
dfpFtest$Centrality[as.character(dfpFtest$Centrality) == " c"] = 'c'
dfpFtest$Centrality[as.character(dfpFtest$Centrality) == " NA"] = 'p'
dfpFtest$Centrality[as.character(dfpFtest$Centrality) == "NA"] = 'p'
dfpFtest$Centrality[is.na(dfpFtest$Centrality)] = 'p'

dfpFtest$Ncp = (df2 + df1 +1)/( df1 +1)
NcpF= dfpFtest$Ncp

```


```{r ReadttestsMC, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
pTtest=unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[1]), split = ","))
Tttests=unlist(strsplit(gsub("\\[|\\]|\\'","",data$Tttest[1]), split = ","))
df=unlist(strsplit(gsub("\\[|\\]|\\'","", data$dfttest[1]), split = ","))
pTtest=unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[1]), split = ","))
TtestCom <-  unlist(strsplit(gsub("\\[|\\]","",data$ttests[1]), split = "', '"))

CentralityT=unlist(strsplit(gsub("\\[|\\]|\\'","", data$centralityT[1]), split = ","))
WithinT=unlist(strsplit(gsub("\\[|\\]|\\'","", data$withinT[1]), split = ","))

Mturk=unlist(strsplit(gsub("\\[|\\]|\\'","", data$OnlineSampleT[1]), split = ","))
pTtest[length(TtestCom)==0] <- NA

Tttests[length(TtestCom)==0] <- NA
df[length(TtestCom)==0] <- NA
TtestCom[length(TtestCom)==0] <- NA
Journal = rep(data$Journal[1], length(TtestCom))
Year = rep(data$Year[1], length(TtestCom))
Article = rep(1, length(TtestCom))
dfpTtest <- cbind(TtestCom, pTtest, Tttests, df, CentralityT, Mturk, Journal,  Year, Article, WithinT)
error=rep(NA, length(data$pvaluesttests))
test = rep(0, length(data$pvaluesttests))
test[1] = length(TtestCom) - length(pTtest)
  
for (i in 2:length(data$pvaluesttests)){
  
  TtestCom <-  unlist(strsplit(gsub("\\[|\\]","", data$ttests[i]), split = "', '"))
  pTtest=unlist(strsplit(gsub("\\[|\\]|\\'","",data$pvaluesttests[i]), split = ","))
  Tttests=unlist(strsplit(gsub("\\[|\\]|\\'","",data$Tttest[i]), split = ","))
  CentralityT=unlist(strsplit(gsub("\\[|\\]|\\'","",data$centralityT[i]), split = ","))
  WithinT=unlist(strsplit(gsub("\\[|\\]|\\'","", data$withinT[i]), split = ","))
  
  Mturk=unlist(strsplit(gsub("\\[|\\]|\\'","",data$OnlineSampleT[i]), split = ","))
  df=unlist(strsplit(gsub("\\[|\\]|\\'","", data$dfttest[i]), split = ","))
  
  pTtest[length(TtestCom)==0] <- NA
  CentralityT[length(TtestCom)==0] <- "NA"
  WithinT[length(TtestCom)==0] <- NA
  Mturk[length(TtestCom)==0] <- NA
  Tttests[length(TtestCom)==0] <- NA
  df[length(TtestCom)==0] <- NA
  TtestCom[length(TtestCom)==0] <- NA
  Journal = rep(data$Journal[i], length(TtestCom))
  Year = rep(data$Year[i], length(TtestCom))
  Article = rep(i, length(TtestCom))
  
  test[i] = length(TtestCom) - length(pTtest)
 
  dfpTtest <- rbind(dfpTtest,
                    cbind(TtestCom, pTtest, Tttests, df, CentralityT, Mturk, Journal, Year, Article, WithinT))
}

dfpTtest = as.data.frame(dfpTtest)



dfpTtest$Mturk[dfpTtest$Mturk ==" n"| dfpTtest$Mturk ==" n "| is.na(dfpTtest$Mturk)] = "n"
dfpTtest$Mturk[dfpTtest$Mturk ==" y"| dfpTtest$Mturk ==" y "] = "y"
dfpTtest$Mturk = factor(dfpTtest$Mturk)

errorsT = which(test != 0)


exactt = 1 - grepl("b|<|>",dfpTtest[,1])#str_count(dfpTtest[,1], "=") + str_count(dfpTtest[,1], "p")
prept = as.numeric(as.character(dfpTtest[,2]))
Tvalue = as.numeric(as.character(dfpTtest[,3]))
Tvalue[Tvalue < 0 & !is.na(Tvalue)] = abs(Tvalue[Tvalue < 0& !is.na(Tvalue)])
df = as.numeric(as.character(dfpTtest[,4]))

Nt = df + 2

d = 2*Tvalue/sqrt(Nt)



#sqrt(N/.5 )*(d/(sqrt(2)))- qnorm(1-alpha)= qnorm(po)
#transform d to r assuming equal sample sizes, thus correction factor a = 4
rt = d/sqrt(d^2 + (Nt^2-2*Nt)/(.5*Nt)^2)

pcalt=1-pt(Tvalue, df,0)
dfpTtest = cbind(dfpTtest, pcalt)



PerArticlet= as.data.frame(cbind(data$Year, data$Journal, data$Type.of.Study, data$Nocoauthors))

for (i in 1:length(data$pvaluesttests)){
  PerArticlet$TperArticle[i] =length(dfpTtest[dfpTtest$Article==i & dfpTtest$CentralityT != "m",1]) 
  PerArticlet$TperArticle[i][data$ttest[i] =="[]"] = 0
  PerArticlet$TperArticlep[i] =length(dfpTtest[dfpTtest$Article==i & dfpTtest$CentralityT != "m" & as.numeric(dfpTtest$pTtest) < .05,1]) 
  PerArticlet$TperArticlep[i][data$ttests[i] =="[]"] = 0
    PerArticlet$NoCoauthors[i]= data$Nocoauthors[i]
  PerArticlet$NoStudies[i]=  sum(unlist(strsplit(gsub("\\[|\\]|\\'","", data$Type.of.Study[i]), split = ",")) != "")
  PerArticlet$TypeStudies[i]=   sum(unlist(strsplit(gsub("\\[|\\]|\\'","", data$Type.of.Study[i]), split = ",")) %in% c("field", " field"))
}



dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == " p"] = 'p'
dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == " m"] = 'm'
dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == " c"] = 'c'

dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == "c "] = 'c'
dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == " NA"] = 'p'
dfpTtest$CentralityT[as.character(dfpTtest$CentralityT) == "NA"] = 'p'
dfpTtest$CentralityT[is.na(dfpTtest$Centrality)] = 'p'
dfpTtest$Ncp = Nt/2
NcpT= dfpTtest$Ncp

```

```{r, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}
PerArticle = PerArticlet

PerArticle$TperArticle = PerArticlet$TperArticle +PerArticleF$FperArticle

PerArticle$TperArticlep = PerArticlet$TperArticlep +PerArticleF$FperArticlep

colnames(PerArticle) = c( "Year", "Journal","Type", "Number", "Tests", "signp", "NoCoAuthors", "NoStudies", "FieldStudies")


PerArticle$signp[PerArticle$Tests != 0 ]= PerArticle$signp[PerArticle$Tests != 0 ]/ PerArticle$Tests[PerArticle$Tests != 0 ]
PerArticle$signp[PerArticle$Tests == 0 ] = NA


dfpFtest = as.data.frame(dfpFtest)
dfpTtest = as.data.frame(dfpTtest)

dfpFtest$Mturk[dfpFtest$Mturk == unique(dfpFtest$Mturk)[3]] =unique(dfpFtest$Mturk)[2]
dfpFtest$Mturk= factor(dfpFtest$Mturk)


summaryTests = as.data.frame(rbind(cbind(NF,NcpF, rF,prepF, pcalF, exactF, dfpFtest$Journal, dfpFtest$Year,dfpFtest$Mturk, dfpFtest$Article, rep("F", length(NF)),as.character(dfpFtest$Centrality),as.character(dfpFtest$Within)),
                     cbind(Nt, NcpT, rt,prept, pcalt, exactt, dfpTtest$Journal, dfpTtest$Year,dfpTtest$Mturk, dfpTtest$Article, rep("t", length(Nt)),as.character(dfpTtest$CentralityT),as.character(dfpTtest$WithinT))))
summaryTests = as.data.frame(summaryTests)
summaryTests[,1] = as.numeric(as.character(summaryTests[,1]))
summaryTests[,2] = as.numeric(as.character(summaryTests[,2]))
summaryTests[,3] = as.numeric(as.character(summaryTests[,3]))
summaryTests[,4] = as.numeric(as.character(summaryTests[,4]))
summaryTests[,5] = as.numeric(as.character(summaryTests[,5]))
summaryTests[,6] = as.numeric(as.character(summaryTests[,6]))


colnames(summaryTests) = c("N", "Ncp", "r", "prep", "pcal",  "exact", "Journal", "Year", "Mturk", "Article", "Type","Centrality", "Within")


summaryTests$facPcal = NA
summaryTests$facPcal[summaryTests[,5] < .01]= .01
for (i in 2:length(seq(.01,1,.01))){
  
summaryTests$facPcal[summaryTests[,5] >= seq(.01,1,.01)[i-1] &summaryTests[,5] < seq(.01,1,.01)[i]]= seq(.01,1,.01)[i]
}




summaryTests$Centrality[as.character(summaryTests$Centrality) == " c "] = 'c'


summaryTests$Centrality= factor(summaryTests$Centrality)

summaryTests$facPcal = as.factor(summaryTests$facPcal)

summaryTests$Within = gsub(" ", "", summaryTests$Within)

# 
# testsforpcurve = cbind(c(as.character(dfpFtest$FtestCom[dfpFtest$Centrality =="c"]),as.character(dfpTtest$TtestCom[dfpTtest$CentralityT =="c"])), c(as.character(dfpFtest$Year[dfpFtest$Centrality =="c"]),as.character(dfpTtest$Year[dfpTtest$CentralityT =="c"])),
#                                                                                                                                                     c(as.character(dfpFtest$Journal[dfpFtest$Centrality =="c"]),as.character(dfpTtest$Journal[dfpTtest$CentralityT =="c"])))
# 
# 
# OrigProbC = round(c(with(summaryTests[summaryTests$Year == 1 & !is.na(summaryTests$r)& summaryTests$Centrality == "c", ], c(median(r),mean(pcal <.05), mean(pcal >=.005 & pcal <.05), mean(pcal <.005))),with(summaryTests[summaryTests$Year == 8 & !is.na(summaryTests$r)& summaryTests$Centrality == "c", ], c(median(r),mean(pcal <.05), mean(pcal >=.005 & pcal <.05), mean(pcal <.005)))),2)


summaryTests$HypothesisTest = as.factor(summaryTests$Centrality != "m")

PerArticle$Journal[PerArticle$Journal == "JcP"] = "JCP"
PerArticle$Journal[PerArticle$Journal == "JcR"] = "JCR"
```

### Number of studies, co-authors and proportion of field studies


```{r}

perJournal =

rbind(
tapply(PerArticle$NoStudies,PerArticle$Journal, mean),
tapply(PerArticle$NoCoAuthors,PerArticle$Journal, mean, na.rm = T),
tapply(PerArticle$FieldStudies> 0,PerArticle$Journal, mean))
row.names(perJournal) = c("Nostudies", "NoCoauthors", "PR(Field Studies)")


perYear = rbind(
tapply(PerArticle$NoStudies,as.numeric(PerArticle$Year), mean),
tapply(PerArticle$NoCoAuthors,as.numeric(PerArticle$Year), mean, na.rm = T),
tapply(PerArticle$FieldStudies> 0,as.numeric(PerArticle$Year), mean))

row.names(perYear) = c("Nostudies", "NoCoauthors", "PR(Field Studies)")

kable(round(perJournal,2))
kable(round(perYear,2))

```


### Sample size per cell


Calculation of the sample size for the F-test:
  
Assuming that most of the test compare independent groups we approximated the sample sizes via $N = df_2 + df_1 +1$ \newline
K = Number of groups\newline
$df_1 = K-1$ \newline
$df_2 = N-K$ \newline

Calculation of the sample size for the t-test:
  As for the F-tests we assumed that most of the studies represent manipulations between subjects. Thus we approximated the total sample size with the df of the t-tests: $N = df +2$
  
The sample size per cell can next be estimated by dividing the total sample size with the number of conditions (k).

```{r echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}



data_list  <- list(
  y = summaryTests$Ncp[!is.na(summaryTests$N) &summaryTests$Within == "b"& summaryTests$Centrality != "m"],
  y1 = summaryTests$r[!is.na(summaryTests$N) &summaryTests$Within == "b"& summaryTests$Centrality != "m"],
  x0 = as.numeric(summaryTests$N[!is.na(summaryTests$N) &summaryTests$Within == "b"&summaryTests$Centrality != "m"]),
  x1 = as.factor(summaryTests$Journal[!is.na(summaryTests$N)&summaryTests$Within == "b" &summaryTests$Centrality != "m"]),
  x2 = as.numeric(summaryTests$Year[!is.na(summaryTests$N) &summaryTests$Within == "b"&summaryTests$Centrality != "m"]),
  x3 = as.factor(summaryTests$Article[!is.na(summaryTests$N)&summaryTests$Within == "b" &summaryTests$Centrality != "m"]),
  
  x4 = as.factor(summaryTests$Mturk[!is.na(summaryTests$N) &summaryTests$Within == "b" &summaryTests$Centrality != "m"])
)


summaryTests$Year = as.numeric(summaryTests$Year)


NCPhandcoded = ggplot(summaryTests[summaryTests$HypothesisTest == T & summaryTests$Within == "b" & summaryTests$Ncp < quantile(summaryTests$Ncp, prob = .99, na.rm = T),], aes(y = Ncp, x= Year, group = Mturk, linetype = Mturk, shape = Mturk))+
#geom_violin(draw_quantiles = c(0.025, 0.5, 0.975))+
  stat_summary(fun.y = "median", geom = "line",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
   stat_summary(fun.data = "median_hilow", fun.args=list(conf.int=0.5),geom = "pointrange",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  scale_linetype_discrete(label= c("No", "Yes"), name = "Online Sample")+
  scale_shape_manual(values = c(1,2), label= c("No", "Yes"), name = "Online Sample")+
  ylab(expression(paste("Sample Size")))+
  geom_point(position = position_jitterdodge(dodge.width = .6), alpha = .15, na.rm = TRUE) +
  scale_x_continuous(name = "Year", breaks = c(8,9,10,11,12,13,14,15,16,17,18, 19, 20), labels = c("2008","","2010","","2012","","2014","","2016","","2018","","2020"))+
                theme_classic()+
  coord_cartesian(ylim = c(0,500))+
                ggtitle("Sample Size")+
                theme(tex = element_text(size=12),
                      plot.title = element_text(hjust=.5, size=15, face="bold"))+
  theme(axis.ticks.length=unit(-0.15, "cm"), axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), legend.position = "bottom" )



grid.arrange(NCPhandcoded + ylab( "Sample Size per Cell") + ggtitle("Handcoded Articles"),
             NPCall + ggtitle("Text Mined Articles"), ncol = 2, top = "Figure 1")


datafreq = as.data.frame(cbind(data_list$y, log(data_list$y +1), data_list$y1, log((data_list$y1 + .00001)/(1-(data_list$y1 + .00001))), data_list$x1, data_list$x2, data_list$x3, data_list$x4))
colnames(datafreq) = c("Npc", "logNpc", "r", "logr", "Journal", "Year", "Article", "Mturk")


datafreq2 = datafreq[datafreq$Npc< quantile(datafreq$Npc, prob = .99, na.rm = T),]

modlogNYearMturk= lmer(`logNpc`  ~ Year+Mturk   +(1|Article), data=datafreq2)

tab_model(modlogNYearMturk)

```

### Effect size (r)


The effect sizes of the F, $\omega^2$, and t-test, d, were transformed to the commmon r-scale, to be analyzed and plotted together. 


```{r echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}




datafreq$Journal= factor(datafreq$Article)
datafreq$Article= factor(datafreq$Article)
datafreq$Mturk= factor(datafreq$Mturk)

summaryTests$HypothesisTest = factor(summaryTests$HypothesisTest)


rHandcodedH = ggplot(summaryTests[summaryTests$HypothesisTest == T, ], aes(y = r, x= Year, shape =factor(Mturk), group= factor(Mturk), linetype = factor(Mturk)))+
#geom_violin(draw_quantiles = c(0.025, 0.5, 0.975))+
  stat_summary(fun = "median", geom = "line",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
   stat_summary(fun.data = "median_hilow", fun.args=list(conf.int=0.5),geom = "pointrange",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
  ylab(expression(paste("r")))+
  geom_jitter( alpha = .15) +
  scale_x_continuous(name = "Year", breaks = c(8,9,10,11,12,13,14,15,16,17,18, 19, 20), labels = c("2008","","2010","","2012","","2014","","2016","","2018","","2020"))+
   scale_shape_manual(values = c(1,2), label= c("No", "Yes"), name = "Online Sample")+
    geom_hline(yintercept = .1, linetype = 2)+
  geom_text(aes(y = .13, x = 8.25, label = "small"))+
  geom_hline(yintercept = .3, linetype = 2)+
  geom_text(aes(y = .33, x = 8.25, label = "medium"))+
  geom_hline(yintercept = .5, linetype = 2)+
  geom_text(aes(y = .53, x = 8.25, label = "large" ))+
                theme_classic()+  
                ggtitle("Hypothesis Tests")+
                theme(tex = element_text(size=12),
                      plot.title = element_text(hjust=.5, size=12))+
  theme(axis.ticks.length=unit(-0.15, "cm"), axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")))



rHandcodedM =ggplot(summaryTests[summaryTests$HypothesisTest == F, ], aes(y = r, x= Year, shape = Mturk, group= Mturk, linetype = Mturk))+
#geom_violin(draw_quantiles = c(0.025, 0.5, 0.975))+
  stat_summary(fun = "median", geom = "line",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
   stat_summary(fun.data = "median_hilow", fun.args=list(conf.int=0.5),geom = "pointrange",position = position_dodge(width = .6), na.rm = TRUE, size = .75)+
    geom_hline(yintercept = .1, linetype = 2)+
  geom_text(aes(y = .13, x = 8.25, label = "small"))+
  geom_hline(yintercept = .3, linetype = 2)+
  geom_text(aes(y = .33, x = 8.25, label = "medium"))+
  geom_hline(yintercept = .5, linetype = 2)+
  geom_text(aes(y = .53, x = 8.25, label = "large" ))+
  ylab(expression(paste("r")))+
  geom_jitter( alpha = .15) +
  scale_x_continuous(name = "Year", breaks = c(8,9,10,11,12,13,14,15,16,17,18, 19, 20), labels = c("2008","","2010","","2012","","2014","","2016","","2018","","2020"))+
   scale_shape_manual(values = c(1,2), label= c("No", "Yes"), name = "Online Sample")+
                theme_classic()+  
                ggtitle("Manipulation Checks")+
                theme(tex = element_text(size=12),
                      plot.title = element_text(hjust=.5, size=12))+
  theme(axis.ticks.length=unit(-0.15, "cm"), axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")), axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")))




grid.arrange(arrangeGrob(rHandcodedH+ theme(legend.position = "none"),  rHandcodedM + theme(legend.position = "none"), top =textGrob("Handcoded Articles", gp = gpar(fontsize = 20, fontface = "bold")), ncol = 1),            rAll + ggtitle("Text Mined Articles") + theme(legend.position = "none"), ncol = 2, top = "Figure 2")



modr= lmer(logr ~ Year + Mturk  +(1|Article), data=datafreq)
modrC= lmer(logr ~ Year + Mturk + logNpc   +(1|Article), data=datafreq)


tab_model(modr)
tab_model(modrC)


```



```{r}

###### The following plot cannot be knitted
# p = ggplot(summaryTests[summaryTests$HypothesisTest == T & summaryTests$Ncp < quantile(summaryTests$Ncp, prob = .99), ],aes(y = r, x= Ncp, color = Mturk))+
#   geom_point(size = 2)+
#   xlab("Sample size per cell")+
#   ylab("Effect size r")+
#ggtitle("Figure 3")
#   scale_color_manual(values = c("black", "grey70"),label= c("No", "Yes"), name = "Online Sample")+
#         theme_bw()+theme(text = element_text(size=12), legend.position = "bottom")
# ggExtra::ggMarginal(p, type = "histogram")



```


### P-value distirbution and z-curve analysis

```{r, echo=FALSE, eval = TRUE, error=FALSE, message=FALSE,warning = FALSE}



summaryTests =summaryTests[!is.na(summaryTests$pcal),]

summaryTests$pcalDir = summaryTests$pcal * 2

for (i in 1:length(summaryTests$pcal)){
  if(!is.na(summaryTests$pcal)[i] & !is.na(summaryTests$prep)[i] & summaryTests$pcal[i]/summaryTests$prep[i] > .6){
    
summaryTests$pcalDir[i]=summaryTests$pcal[i]
  }
  
}

summaryTests$prep[summaryTests$prep > 1] = NA

summaryTests$pcalDir[summaryTests$pcalDir > 1] = .99





# Remove manipulationchecks from the p-values


summaryTestsNoM = summaryTests[summaryTests$Centrality != "m",]
# 
# 
# # discrepancy between the reported and recalculated p-values
# ### Exact Format
#  
# mean((round(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1],2) - round(summaryTestsNoM$prep[summaryTestsNoM$exact == 1],2))^2, na.rm= T)
# mean((summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1] -summaryTestsNoM$prep[summaryTestsNoM$exact == 1]), na.rm= T)
# mean((summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1] -summaryTestsNoM$prep[summaryTestsNoM$exact == 1])^2 > .01^2, na.rm= T)
# 
# 
# prop.test(x = c(sum(summaryTestsNoM$prep[summaryTestsNoM$exact == 1] < .05, na.rm = T), sum(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1] < .05, na.rm = T)), n = c(sum(!is.na(summaryTestsNoM$prep[summaryTestsNoM$exact == 1])), sum(!is.na(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1]))))




propP = matrix(NA, ncol =4, nrow =13)

for (Y in 8:20){
if(sum(!is.na(summaryTestsNoM$prep[summaryTestsNoM$exact == 1 & summaryTestsNoM$Year ==Y])) > 0){
propP[Y-7, ] = as.numeric(unlist(prop.test(x = c(sum(summaryTestsNoM$prep[summaryTestsNoM$exact == 1 & summaryTestsNoM$Year ==Y ] < .05, na.rm = T), sum(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1 & summaryTestsNoM$Year ==Y] < .05, na.rm = T)), n = c(sum(!is.na(summaryTestsNoM$prep[summaryTestsNoM$exact == 1 & summaryTestsNoM$Year ==Y])), sum(!is.na(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 1 & summaryTestsNoM$Year ==Y]))))[c(1,3:4)]))
}}

propP = as.data.frame(propP)

summaryTestsNoM$Year = as.numeric(summaryTestsNoM$Year)



# calculate two-sided p-values



summaryTestsNoM$pcalTwo = summaryTestsNoM$pcal*2

summaryTestsNoM$pcalTwo[summaryTestsNoM$pcalTwo >= 1] = .999


summaryTests$pcalTwo = summaryTests$pcal*2

summaryTests$pcalTwo[summaryTests$pcalTwo >= 1] = .999


# calculate z-scores

summaryTestsNoM$zscore= qnorm(1-summaryTestsNoM$pcalTwo/2)


# set max z-scores for pcal == 0

summaryTestsNoM$zscore= qnorm(1-summaryTestsNoM$pcalTwo/2)

summaryTestsNoM$zscore[summaryTestsNoM$zscore == Inf] = 2.220446e-16

summaryTestsNoM$zscoreD= qnorm(1-summaryTestsNoM$pcalDir/2)

summaryTestsNoM$zscoreD[summaryTestsNoM$zscoreD == Inf] = 2.220446e-16



colnames(propP) = c("chi", "p","prep","pcal") 
propP$Year = 2008:2020
propP$diff = propP$pcal -propP$prep 

propPthr = matrix(NA, ncol =4, nrow =13)

for (Y in 8:20){
if(sum(!is.na(summaryTestsNoM$prep[summaryTestsNoM$exact == 0 & summaryTestsNoM$Year ==Y])) > 0){
propPthr[Y-7, ] = as.numeric(unlist(prop.test(x = c(sum(summaryTestsNoM$prep[summaryTestsNoM$exact == 0 & summaryTestsNoM$Year ==Y ] <= .05, na.rm = T), sum(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 0 & summaryTestsNoM$Year ==Y] <= .05, na.rm = T)), n = c(sum(!is.na(summaryTestsNoM$prep[summaryTestsNoM$exact == 0 & summaryTestsNoM$Year ==Y])), sum(!is.na(summaryTestsNoM$pcalDir[summaryTestsNoM$exact == 0 & summaryTestsNoM$Year ==Y]))))[c(1,3:4)]))
}}

propPthr= as.data.frame(propPthr)

colnames(propPthr) = c("chi", "p","prep","pcal") 
propPthr$diff = propPthr$pcal -propPthr$prep 
propPthr$Year = 2008:2020

##### FIgure 3
direction = c("two-sided", "one- and two-sided")


Propboth = cbind(rbind(propP,propPthr), "Format p-values" = rep( c("Exact (p=.05)", "Threshold (p<.05)"), each=13))

ggplot(Propboth, aes(x=factor(Year), y = diff, group = `Format p-values`, linetype = `Format p-values`))+
  geom_line()+
  ggtitle("Figure 4")+
  # geom_line(data = propPthr, aes(x=factor(Year), y = diff, group = 1), linetype = "dashed")+
  ylab(bquote(PR(p[cal]< .05) - PR(p[rep] < .05)))+
  # scale_linetype_manual(values = direction)+
  xlab("Year")+
  geom_hline(yintercept = 0)+
  theme_bw()+
  theme(text = element_text(size=12))


#crreate bins for plotting the p-curve

summaryTests$Catpcal =  cut(summaryTests$pcalDir, breaks = seq(0,1,length.out = 201), right = F)

summaryTests$CatpcalCurve =  cut(summaryTests$pcalDir, breaks = seq(0,1,length.out = 101), right = F)


aggrsummaryTests = aggregate(summaryTests$Catpcal[summaryTests$Centrality != "m" & !is.na(summaryTests$pcalDir) ], list(summaryTests$Year[summaryTests$Centrality != "m"& !is.na(summaryTests$pcal) ],summaryTests$Catpcal[summaryTests$Centrality != "m" & !is.na(summaryTests$pcalDir) ] ), length)

aggrsummaryTests2 = aggregate(summaryTests$CatpcalCurve[summaryTests$Centrality != "m" & !is.na(summaryTests$pcalDir) ], list(summaryTests$Year[summaryTests$Centrality != "m"& !is.na(summaryTests$pcal) ],summaryTests$CatpcalCurve[summaryTests$Centrality != "m" & !is.na(summaryTests$pcalDir) ] ), length)


colnames(aggrsummaryTests) = c("year", "bin", "Freq")
colnames(aggrsummaryTests2) = c("year", "bin", "Freq")
#aggrsummaryTests$year = as.numeric(aggrsummaryTests$year)

for ( i in 1:length(unique(summaryTests$Year))){
aggrsummaryTests$Test[aggrsummaryTests$year == i + 7] = sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)  
aggrsummaryTests$Prop[aggrsummaryTests$year == i + 7] = aggrsummaryTests[aggrsummaryTests$year == i + 7, 3] / sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)
#print(sum(aggrsummaryTests$Prop[aggrsummaryTests$year == i + 7]))

aggrsummaryTests2$Test[aggrsummaryTests2$year == i + 7] = sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)  
aggrsummaryTests2$Prop[aggrsummaryTests2$year == i + 7] = aggrsummaryTests2[aggrsummaryTests$year == i + 7, 3] / sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)


}


#aggrsummaryTests$bin = factor(aggrsummaryTests$bin, levels(aggrsummaryTests$bin), labels = seq(0,1,length.out = 201)[-201])


labelsAxis= c(".005)",".01)",".015)",".02)",".025)",".03)",".035)",".04)",".045)",".05)",".055)",".06)",".065)",".07)")
labelsAxis2= c(".01)",".02)",".03)",".04)",".05)",".06)",".07)")

aggrsummaryTests = as.data.frame(aggrsummaryTests)

aggrsummaryTests$year = as.numeric(aggrsummaryTests$year) + 2000

aggrsummaryTests2 = as.data.frame(aggrsummaryTests2)

aggrsummaryTests2$year = as.numeric(aggrsummaryTests2$year) + 2000








```

```{r}


summaryTests$Catpcal2 =  cut(summaryTests$pcalTwo, breaks = seq(0,1,length.out = 201), right = F)

summaryTests$Catpcal2Curve =  cut(summaryTests$pcalTwo, breaks = seq(0,1,length.out = 101), right = F)

aggrsummaryTestsTwo = aggregate(summaryTests$Catpcal2[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ], list(summaryTests$Year[summaryTests$Centrality != "m"& !is.na(summaryTests$pcal) ],summaryTests$Catpcal2[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] ), length)

aggrsummaryTestsTwo2 = aggregate(summaryTests$Catpcal2Curve[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ], list(summaryTests$Year[summaryTests$Centrality != "m"& !is.na(summaryTests$pcal) ],summaryTests$Catpcal2Curve[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] ), length)


colnames(aggrsummaryTestsTwo) = c("year", "bin", "Freq")
colnames(aggrsummaryTestsTwo2) = c("year", "bin", "Freq")
#aggrsummaryTestsTwo$year = as.numeric(aggrsummaryTestsTwo$year)

aggrsummaryTestsTwo2 = as.data.frame(aggrsummaryTestsTwo2)
aggrsummaryTestsTwo = as.data.frame(aggrsummaryTestsTwo)

for ( i in 1:length(unique(summaryTests$Year))){
aggrsummaryTestsTwo$Test[aggrsummaryTestsTwo$year == i + 7] = sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)  
aggrsummaryTestsTwo$Prop[aggrsummaryTestsTwo$year == i + 7] = aggrsummaryTestsTwo[aggrsummaryTestsTwo$year == i + 7, 3] / sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)


aggrsummaryTestsTwo2$Test[aggrsummaryTestsTwo2$year == i + 7] = sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)  
aggrsummaryTestsTwo2$Prop[aggrsummaryTestsTwo2$year == i + 7] = aggrsummaryTestsTwo2[aggrsummaryTestsTwo2$year == i + 7, 3] / sum(summaryTests$Year[summaryTests$Centrality != "m" & !is.na(summaryTests$pcal) ] == i+7)


}


#aggrsummaryTestsTwo$bin = factor(aggrsummaryTestsTwo$bin, levels(aggrsummaryTestsTwo$bin), labels = seq(0,1,length.out = 201)[-201])


labelsAxis= c(".005)",".01)",".015)",".02)",".025)",".03)",".035)",".04)",".045)",".05)",".055)",".06)",".065)",".07)")
labelsAxis2= c(".01)",".02)",".03)",".04)",".05)",".06)",".07)")

aggrsummaryTestsTwo = as.data.frame(aggrsummaryTestsTwo)

aggrsummaryTestsTwo$year = as.numeric(aggrsummaryTestsTwo$year) + 2000

aggrsummaryTestsTwo2 = as.data.frame(aggrsummaryTestsTwo2)

aggrsummaryTestsTwo2$year = as.numeric(aggrsummaryTestsTwo2$year) + 2000

# ggplot(aggrsummaryTestsTwo2[as.numeric(as.character(factor(aggrsummaryTestsTwo2$bin, levels(aggrsummaryTestsTwo2$bin), labels = seq(0,1,length.out = 101)[-101]))) < .07,], aes(x = bin, y = Prop))+
#   geom_bar(stat= "identity")+
#   geom_vline(xintercept = 5.5)+
#   facet_wrap(.~ year)+
#   ylab("Proportion of Test Results")+
#   scale_x_discrete(name = "p-value", labels = labelsAxis2)+
#   theme_bw()+
#   theme(text = element_text(size=12), axis.text.x = element_text(size = 12,vjust = 0.5))


aggrsummaryTestsTwo2 = cbind(rbind(aggrsummaryTestsTwo2, aggrsummaryTests2), "direction" = c(rep("two-sided", length(aggrsummaryTestsTwo2[,1])),rep("one- and two-sided", length(aggrsummaryTests2[,1]))))


ggplot(aggrsummaryTestsTwo2[as.numeric(as.character(factor(aggrsummaryTestsTwo2$bin, levels(aggrsummaryTestsTwo2$bin), labels = seq(0,1,length.out = 101)[-101]))) < .07,], aes(x = bin, y = Prop, fill = direction))+
  geom_bar(stat= "identity", position = position_dodge(width = .8))+
  ggtitle("Figure 5")+
  geom_vline(xintercept = 5.5)+
  facet_wrap(.~ year)+
  ylab("Proportion of Test Results")+
  scale_x_discrete(name = "p-value", labels = labelsAxis2)+
  theme_bw()+
  theme(text = element_text(size=12), axis.text.x = element_text(size = 12,vjust = 0.5))
  
```

```{r, eval = F}


library(zcurve)
# z = zcurve(summaryTestsNoM$zscore)
zD = zcurve(summaryTestsNoM$zscoreD)

# 
# z8 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "8"])
# z9 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "9"])
# z10 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "10"])
# z11 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "11"])
# z12 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "12"])
# z13 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "13"])
# z14 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "14"])
# z15 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "15"])
# z16 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "16"])
# z17 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "17"])
# z18 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "18"])
# z19 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "19"])
# z20 = zcurve(summaryTestsNoM$zscore[summaryTestsNoM$Year == "20"])


z8d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "8"])
z9d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "9"])
z10d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "10"])
z11d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "11"])
z12d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "12"])
z13d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "13"])
z14d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "14"])
z15d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "15"])
z16d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "16"])
z17d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "17"])
z18d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "18"])
z19d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "19"])
z20d = zcurve(summaryTestsNoM$zscoreD[summaryTestsNoM$Year == "20"])



ERRs =
cbind(rbind(
  quantile(z8d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z9d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z10d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z11d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z12d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z13d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z14d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z15d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z16d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z17d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z18d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z19d$coefficients_boot[,1], prob = c(.025, .5,.975)),
  quantile(z20d$coefficients_boot[,1], prob = c(.025, .5,.975))), "year" = 8:20)
  
ERRs = as.data.frame(ERRs)
ERRs$`2.5%` = as.numeric(ERRs$`2.5%`)

ERRs$`50%` = as.numeric(ERRs$`50%`)

ERRs$`97.5%` = as.numeric(ERRs$`97.5%`)

ERRs$year = as.numeric(ERRs$year)




plot(zD, CI = TRUE, annotation = TRUE, main = "2008-2020 -(Figure 6)")


ggplot(ERRs, aes( y = `50%`, x = year, ymin = `2.5%`,ymax = `97.5%`,groupd = 1))+
  geom_line()+
  ylab("Expected replicability rate (95%CI)")+
  ggtitle("Figure 7")+
   scale_x_continuous(name = "Year", breaks = c(8,9,10,11,12,13,14,15,16,17,18, 19, 20), labels = c("2008","","2010","","2012","","2014","","2016","","2018","","2020"))+
  geom_pointrange()+
  theme_bw()+
  theme(text = element_text(size=12))
```

